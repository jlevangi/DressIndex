# Platform & Build

Source files: `vite.config.js`, `Dockerfile`, `docker-entrypoint.sh`, `capacitor.config.ts`, `src/sw.js`, `src/firebase.js`, `scripts/ensure-node-modules.mjs`

---

## PWA (Progressive Web App)

### Vite Plugin Configuration

Uses `vite-plugin-pwa` with `injectManifest` strategy:

```
strategies: "injectManifest"
srcDir: "src"
filename: "sw.js"
registerType: "autoUpdate"
```

### Precache Patterns

```
globPatterns: ["**/*.{js,css,html,svg,png,ico,woff2}"]
globIgnores: ["**/Gemini_Generated_*.png"]
```

The `injectManifest` strategy means the service worker source (`src/sw.js`) is bundled through Vite, allowing ES module `import` statements. The build injects a `self.__WB_MANIFEST` variable containing the precache manifest, consumed by `precacheAndRoute()`.

### Service Worker Lifecycle

```javascript
self.addEventListener('install', () => self.skipWaiting());
self.addEventListener('activate', (event) => {
  event.waitUntil(self.clients.claim());
});
```

- `skipWaiting()`: New SW activates immediately (no waiting for old tabs to close)
- `clients.claim()`: New SW takes control of all open tabs immediately

Dev mode: PWA plugin is enabled in dev (`devOptions: { enabled: true }`).

### Web App Manifest

Generated by `vite-plugin-pwa`:

| Field | Value |
|-------|-------|
| `name` | DressIndex |
| `short_name` | DressIndex |
| `description` | Weather-based clothing recommendations |
| `theme_color` | `#0a0a0a` |
| `background_color` | `#0a0a0a` |
| `display` | `standalone` |
| `scope` | `/` |
| `start_url` | `/` |

### Icons

| Path | Size | Purpose |
|------|------|---------|
| `icons/icon-192.png` | 192×192 | Standard |
| `icons/icon-512.png` | 512×512 | Standard |
| `icons/icon-maskable-512.png` | 512×512 | `any maskable` |
| `icons/apple-touch-icon-180.png` | 180×180 | Apple touch icon (in `<link>` tag) |
| `appicon.svg` | — | Favicon + in-app brand icon |

---

## Docker

### Multi-Stage Build

```dockerfile
FROM node:22-alpine AS build
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --chmod=755 docker-entrypoint.sh /docker-entrypoint.sh
EXPOSE 80
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]
```

### Runtime Config Injection

The `docker-entrypoint.sh` generates `/usr/share/nginx/html/config.js` at container startup:

```javascript
window.__CONFIG__ = {
  PIRATE_WEATHER_API_KEY: "${VITE_PIRATE_WEATHER_API_KEY:-}"
};
```

This file is loaded via `<script src="/config.js"></script>` in `index.html` (before the module script). If the file doesn't exist (non-Docker), the script tag 404s silently.

The app reads `window.__CONFIG__.PIRATE_WEATHER_API_KEY` as the first priority for API key resolution.

### Nginx Configuration

```
server {
  listen 80;

  # SW: no cache (must always check for updates)
  location = /sw.js { add_header Cache-Control "no-cache, no-store, must-revalidate"; }

  # Manifest: short cache
  location = /manifest.webmanifest { add_header Cache-Control "no-cache, must-revalidate"; }

  # Icons: immutable long cache (1 year)
  location ~* ^/icons/.*\.png$ { add_header Cache-Control "public, max-age=31536000, immutable"; }

  # SPA fallback
  location / { try_files $uri $uri/ /index.html; }
}
```

---

## Capacitor / Android

### Configuration

```typescript
// capacitor.config.ts
const config: CapacitorConfig = {
  appId: 'com.dressindex.app',
  appName: 'DressIndex',
  webDir: 'dist',
};
```

### Build Flow

1. `npm run build` — builds web assets to `dist/`
2. `npx cap sync` — copies `dist/` into `android/app/src/main/assets/public/`
3. Build APK via Gradle

### WSL Build Command

Android SDK and JDK are on the Windows host, so Gradle must run through `cmd.exe`:

```bash
cd android && cmd.exe /c "set ANDROID_HOME=C:\Users\pierc\AppData\Local\Android\Sdk&& set JAVA_HOME=C:\Program Files\Android\Android Studio\jbr&& gradlew.bat assembleDebug"
```

APK output: `android/app/build/outputs/apk/debug/app-debug.apk`

### Android Status Bar Theming

`MainActivity.java` uses `evaluateJavascript` in `onResume()` to read the theme from JS localStorage and apply matching status bar colors (light or dark icons/background).

The splash theme (`AppTheme.NoActionBarLaunch`) in `styles.xml` needs explicit `statusBarColor`, `navigationBarColor`, and `windowLightStatusBar` attributes.

---

## Firebase Analytics

### Setup (Optional)

Firebase is entirely optional. If `VITE_FIREBASE_API_KEY` env var is not set, all logging is silently skipped.

### Configuration (Environment Variables)

| Env Var | Purpose |
|---------|---------|
| `VITE_FIREBASE_API_KEY` | Firebase API key (required to enable) |
| `VITE_FIREBASE_AUTH_DOMAIN` | Auth domain |
| `VITE_FIREBASE_PROJECT_ID` | Project ID |
| `VITE_FIREBASE_STORAGE_BUCKET` | Storage bucket |
| `VITE_FIREBASE_MESSAGING_SENDER_ID` | Messaging sender ID |
| `VITE_FIREBASE_APP_ID` | App ID |

### Authentication

Anonymous auth: `signInAnonymously(auth)` — generates a unique `uid` per device.

### Logging Functions

**`logEvent(collection, data)`**: Writes a document to `users/{uid}/{collection}` with `{ ...data, _env, ts }`.

**`logTopLevel(data)`**: Merges data into `users/{uid}` document with `{ ...data, _env, ts }`.

The `_env` field is `"dev"` or `"prod"` based on `import.meta.env.DEV`.

### Events Logged

| Collection | Trigger | Data |
|------------|---------|------|
| `surveys` | Comfort survey response | response, personalAdj, effectiveTemp, actualTemp, clothingTier |
| `extendedSurveys` | Extended survey submit | clothing, recommendationMatch, layerChange, comfortDriver + comfort context |
| `adjustments` | personalAdj slider change | value |
| (top-level) | Onboarding complete | personalAdj |
| (top-level) | Survey adjust accepted | personalAdj |

All Firestore failures are silently caught — Firebase never breaks the app.

---

## Cross-Platform Dependency Handling

### `scripts/ensure-node-modules.mjs`

Called by `start.sh` before dev server launch. Handles the case where `node_modules` was installed on a different platform (e.g., Windows vs WSL).

**Logic**:
1. Check if `node_modules` exists
2. Read `.node_modules-platform` stamp file for previously installed platform
3. Check if the correct `@rollup/rollup-{platform}-{arch}` native package is present
4. If any check fails: delete `node_modules` and run `npm install`
5. Write current platform tag to stamp file

**Supported platforms**:
- `linux-x64`, `linux-arm64`
- `win32-x64`, `win32-arm64`
- `darwin-x64`, `darwin-arm64`

---

## Vite Configuration

### Cache Directory

Uses a temp directory to avoid WSL cross-filesystem issues:
```
{os.tmpdir()}/vite-cache/dressindex/{platform}-{arch}
```

### Dev Server

```
server: {
  host: true,                    // Listen on all interfaces
  allowedHosts: [...],           // From VITE_ALLOWED_HOSTS env var
  watch: { usePolling: true },   // Required for WSL file watching
}
```

### Global CSS

Two global stylesheets are loaded:
1. `src/theme.css` — imported in `main.jsx`, defines CSS custom properties
2. `index.html` inline `<style>` — reset (`* { margin: 0; ... }`), safe area padding, keyframe animations (`spin`, `pulse`)
